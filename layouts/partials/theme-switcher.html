{{ if .Site.Params.themes.enabled }}
<div class="theme-switcher">
  <select id="theme-select" class="theme-select">
    <option value="">Loading...</option>
  </select>
</div>

<style>
/* Container for both controls */
.site-controls {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 1000;
  display: flex;
  flex-direction: row;
  gap: 0.75rem;
  align-items: center;
}

/* Theme switcher styling to match dark mode toggle */
.theme-switcher {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.theme-select {
  padding: 0.75rem 1rem;
  background: hsl(var(--muted) / 0.2);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid hsl(var(--border) / 0.3);
  border-radius: 12px;
  color: hsl(var(--foreground));
  font-size: 0.875rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px hsl(var(--foreground) / 0.05);
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='currentColor' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 12px;
  padding-right: 2.5rem;
  min-width: 150px;
}

.theme-select:hover {
  background: hsl(var(--muted) / 0.3);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px hsl(var(--foreground) / 0.08);
}

.theme-select:focus {
  outline: none;
  border-color: hsl(var(--primary) / 0.5);
  box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
}

.theme-select option {
  background: hsl(var(--background));
  color: hsl(var(--foreground));
  padding: 0.5rem;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .site-controls {
    bottom: 1rem;
    right: 1rem;
    gap: 0.5rem;
  }
  
  .theme-select {
    padding: 0.6rem 0.8rem;
    padding-right: 2rem;
    font-size: 0.8rem;
    min-width: 120px;
  }
}
</style>

<script>
(function() {
  'use strict';

  const STORAGE_KEY = 'selected-theme';
  const DEFAULT_THEME = '{{ .Site.Params.themes.default | default "default" }}';
  const THEME_BASE_PATH = '/themes/';
  
  let currentTheme = null;
  let loadedThemes = {};

  // Available themes - we'll scan for these
  const themeIds = ['default', 'starfield'];

  // Load theme metadata
  async function loadThemeMetadata(themeId) {
    try {
      const response = await fetch(`${THEME_BASE_PATH}${themeId}/theme.json`);
      if (!response.ok) throw new Error('Theme not found');
      return await response.json();
    } catch (error) {
      console.warn(`Failed to load theme ${themeId}:`, error);
      return null;
    }
  }

  // Load all available themes
  async function loadAllThemes() {
    const themes = [];
    for (const themeId of themeIds) {
      const metadata = await loadThemeMetadata(themeId);
      if (metadata) {
        themes.push(metadata);
        loadedThemes[themeId] = metadata;
      }
    }
    return themes;
  }

  // Populate theme selector
  function populateThemeSelector(themes) {
    const select = document.getElementById('theme-select');
    if (!select) return;

    select.innerHTML = '';
    
    themes.forEach(theme => {
      const option = document.createElement('option');
      option.value = theme.id;
      option.textContent = theme.name;
      option.title = theme.description;
      select.appendChild(option);
    });

    // Set current theme
    const savedTheme = localStorage.getItem(STORAGE_KEY) || DEFAULT_THEME;
    select.value = savedTheme;
  }

  // Unload current theme
  function unloadTheme() {
    // Remove theme CSS
    const existingLink = document.getElementById('theme-css');
    if (existingLink) {
      existingLink.remove();
    }

    // Remove theme JS
    const existingScript = document.getElementById('theme-js');
    if (existingScript) {
      existingScript.remove();
    }

    // Dispatch theme change event for cleanup
    window.dispatchEvent(new Event('themechange'));
  }

  // Load and apply theme
  async function loadTheme(themeId) {
    if (currentTheme === themeId) return;

    // Unload current theme first
    if (currentTheme) {
      unloadTheme();
    }

    // Load CSS
    const cssLink = document.createElement('link');
    cssLink.id = 'theme-css';
    cssLink.rel = 'stylesheet';
    cssLink.href = `${THEME_BASE_PATH}${themeId}/theme.css`;
    document.head.appendChild(cssLink);

    // Check if theme has JS
    try {
      const jsResponse = await fetch(`${THEME_BASE_PATH}${themeId}/theme.js`, { method: 'HEAD' });
      if (jsResponse.ok) {
        const script = document.createElement('script');
        script.id = 'theme-js';
        script.src = `${THEME_BASE_PATH}${themeId}/theme.js`;
        document.body.appendChild(script);
      }
    } catch (error) {
      // No JS file, that's fine
    }

    currentTheme = themeId;
    localStorage.setItem(STORAGE_KEY, themeId);
    
    // Add theme class to body
    document.body.className = document.body.className.replace(/theme-\S+/g, '');
    document.body.classList.add(`theme-${themeId}`);
  }

  // Handle theme selection change
  function handleThemeChange(event) {
    const themeId = event.target.value;
    if (themeId && loadedThemes[themeId]) {
      loadTheme(themeId);
    }
  }

  // Initialize
  async function init() {
    // Load all themes
    const themes = await loadAllThemes();
    
    // Populate selector
    populateThemeSelector(themes);
    
    // Set up event listener
    const select = document.getElementById('theme-select');
    if (select) {
      select.addEventListener('change', handleThemeChange);
    }

    // Load saved theme or default
    const savedTheme = localStorage.getItem(STORAGE_KEY) || DEFAULT_THEME;
    if (loadedThemes[savedTheme]) {
      await loadTheme(savedTheme);
    }
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
{{ end }}
